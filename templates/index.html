<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Trading Data Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <!-- Fallback to local version if CDN fails -->
    <script>
        window.addEventListener('error', function(e) {
            if (e.target.src && e.target.src.includes('unpkg.com/lightweight-charts')) {
                console.log('CDN load failed, using local version');
                const script = document.createElement('script');
                script.src = "{{ url_for('static', filename='lightweight-charts.standalone.production.js') }}";
                document.head.appendChild(script);
            }
        }, true);
    </script>
</head>
<body>
    <div class="header">
        <h1>Trading Data Viewer</h1>
    </div>

    <div class="container">
        <!-- First desk - Essential controls -->
        <div class="controls">
            <!-- First row - Main controls -->
            <div class="controls-row">
                <div class="control-group">
                    <label>Instrument</label>
                    <select id="instrumentSelect">
                        <option value="">Loading instruments...</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Timeframe</label>
                    <select id="timeframeSelect">
                        <option value="raw">Raw Data</option>
                        <option value="1min" selected>1 Minute</option>
                        <option value="5min">5 Minutes</option>
                        <option value="15min">15 Minutes</option>
                        <option value="30min">30 Minutes</option>
                        <option value="60min">1 Hour</option>
                        <option value="120min">2 Hours</option>
                        <option value="240min">4 Hours</option>
                        <option value="1day">Daily</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Start Date</label>
                    <input type="date" id="startDateInput">
                </div>

                <div class="control-group">
                    <label>End Date</label>
                    <input type="date" id="endDateInput">
                </div>

                <div class="control-group">
                    <label>&nbsp;</label>
                    <button id="addInstrumentBtn" class="btn-small" title="Add Second Instrument">
                        <span style="font-size: 14px;">+</span> Add Chart
                    </button>
                </div>
            </div>
            
            <!-- Second row - Second instrument (initially hidden) -->
            <div id="instrument2Row" class="controls-row" style="display: none; margin-top: 15px; border-top: 1px dashed #e5e7eb; padding-top: 15px;">
                <div class="control-group" id="instrument2Group">
                    <label>Instrument 2</label>
                    <select id="instrumentSelect2">
                        <option value="">Select second instrument...</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button id="removeInstrumentBtn" class="btn-small" title="Remove Second Instrument">
                        <span style="font-size: 14px;">-</span> Delete Chart
                    </button>
                </div>
                
                <div class="control-group" id="syncTimeGroup">
                    <label>Chart Options</label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="syncTimeToggle">
                        Sync Time Scales
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Second desk - Drawing tools and analysis -->
        <div class="controls drawing-controls-panel">
            <div class="controls-row">
                <div class="control-group">
                    <label>Drawing Tools</label>
                    <div class="drawing-tools">
                        <button id="hLineBtn" class="tool-btn" title="Horizontal Line">─</button>
                        <button id="hRayBtn" class="tool-btn" title="Horizontal Ray">→</button>
                        <button id="rectBtn" class="tool-btn" title="Rectangle">▭</button>
                        <button id="clearBtn" class="tool-btn" title="Clear All">✖</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Saved Drawings</label>
                    <div class="drawing-saves">
                        <select id="savedDrawingsSelect">
                            <option value="">Load saved drawings...</option>
                        </select>
                        <button id="saveDrawingsBtn" class="btn-small">Save</button>
                        <button id="deleteDrawingsBtn" class="btn-small">Delete</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Technical Analysis</label>
                    <div class="analysis-controls">
                        <div class="analysis-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="supportResistanceToggle">
                                Support/Resistance
                            </label>
                            <label class="checkbox-label sub-option" id="breakoutSignalsLabel" style="opacity: 0.5; margin-left: 20px;">
                                <input type="checkbox" id="breakoutSignalsToggle" disabled>
                                Breakout Signals
                            </label>
                        </div>
                        <label class="checkbox-label">
                            <input type="checkbox" id="trendChannelToggle">
                            Trend Channel
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <div id="chartTitle" class="chart-title">
                Select an instrument to view chart
            </div>
            <div id="chart" style="min-height: 600px; display: flex; flex-wrap: wrap;"></div>
            <div class="chart-footer">
                <button id="loadDataBtn" class="btn-primary">Refresh Data</button>
                <button id="downloadBtn" class="download-btn">Download Data</button>
            </div>
        </div>

        <div class="table-container">
            <div class="table-title">Trading Data</div>
            <div id="tableContent"></div>
        </div>
    </div>

    <!-- Download Modal -->
    <div id="downloadModal" class="download-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Download Data</h3>
                <span class="close" onclick="closeDownloadModal()">&times;</span>
            </div>
            <div class="format-options">
                <div class="format-option selected" data-format="csv">
                    <strong>CSV</strong>
                    <small>Comma-separated values</small>
                </div>
                <div class="format-option" data-format="json">
                    <strong>JSON</strong>
                    <small>JavaScript Object Notation</small>
                </div>
            </div>
            <button id="confirmDownload">Download</button>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>